{{ header }}{{ column_left }}
<div id="content">
    <div class="page-header">
        <div class="container-fluid">
            <div class="pull-right">
                <button type="submit" form="form-module" data-toggle="tooltip" title="{{ button_save }}"
                        class="btn btn-primary"><i class="fa fa-save"></i></button>
                <a href="{{ cancel }}" data-toggle="tooltip" title="{{ button_cancel }}" class="btn btn-default"><i
                            class="fa fa-reply"></i></a></div>
            <h1>{{ heading_title }}</h1>
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                    <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="container-fluid">
        {% if error_warning %}
            <div class="alert alert-danger"><i class="fa fa-exclamation-circle"></i> {{ error_warning }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endif %}
        {% if install_success %}
            <div class="alert alert-success"><i class="fa fa-exclamation-circle"></i> {{ install_success }}
                <button type="button" class="close" data-dismiss="alert">&times;</button>
            </div>
        {% endif %}
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title"><i class="fa fa-pencil"></i> {{ text_edit }}</h3>
            </div>
            <div class="panel-body">
                <form action="{{ action }}" method="post" enctype="multipart/form-data" id="form-module"
                      class="form-horizontal">
                    <div class="form-group">
                        <label class="col-sm-2 control-label" for="input-status">{{ entry_status }}</label>
                        <div class="col-sm-10">
                            <select name="module_whatsappnotifi_status" id="input-status" class="form-control">
                                {% if module_whatsappnotifi_status %}
                                    <option value="1" selected="selected">{{ text_enabled }}</option>
                                    <option value="0">{{ text_disabled }}</option>
                                {% else %}
                                    <option value="1">{{ text_enabled }}</option>
                                    <option value="0" selected="selected">{{ text_disabled }}</option>
                                {% endif %}
                            </select>
                        </div>
                    </div>


                    {% for store in stores %}
                    <div class="row">
                        <div class="form-group col-sm-12">
                            <label class="col-sm-2 control-label" for="input-entry-key">
                                <span data-toggle="tooltip" title="" data-original-title="{{ text_store }}{{ store.name }}">
                                    {{ store.name }}
                                </span>
                            </label>
                            <input type="hidden" name="stores[]" value="{{ store.store_id }}">
                            <div class="col-sm-2">
                                <input class="form-control" placeholder="Whatsapp da loja" id="module_whatsappnotifi_numero_{{ store.store_id }}" type="text" name="module_whatsappnotifi_numero_{{ store.store_id }}" value="{{ store.module_whatsappnotifi_numero }}"/>
                            </div>
                            <div class="col-sm-2">
                                <input class="form-control" placeholder="Instância" id="module_whatsappnotifi_instance_{{ store.store_id }}" type="text" name="module_whatsappnotifi_instance_{{ store.store_id }}" value="{{ store.module_whatsappnotifi_instance }}"/>
                            </div>
                            <div class="col-sm-2">
                                <input class="form-control" placeholder="Token" id="module_whatsappnotifi_token_{{ store.store_id }}" type="text" name="module_whatsappnotifi_token_{{ store.store_id }}" value="{{ store.module_whatsappnotifi_token }}"/>
                            </div>
                            <div class="col-sm-2">
                                <select name="module_whatsappnotifi_store_status_{{ store.store_id }}" class="form-control">
                                    {% if store.module_whatsappnotifi_store_status %}
                                        <option value="1" selected="selected">{{ text_enabled }}</option>
                                        <option value="0">{{ text_disabled }}</option>
                                    {% else %}
                                        <option value="1">{{ text_enabled }}</option>
                                        <option value="0" selected="selected">{{ text_disabled }}</option>
                                    {% endif %}
                                </select>
                            </div>
                            <div class="col-sm-2">
                                <button type="button" id="btnvalida{{ store.store_id }}" onclick="verificastatus('{{ store.store_id }}')" class="btn btn-primary">Verificar</button>
                            </div>
                        </div>
                    </div>
                    <div id="retonovalidacao{{ store.store_id }}" class="alert alert-success col-sm-12 hidden"><i class="fa fa-exclamation-circle"></i>
                        <span id="retornovalidacaomsg{{ store.store_id }}"></span>
                        <button type="button" class="close" data-dismiss="alert">&times;</button>
                    </div>
                    {% endfor %}                   
                    
                </form>
                
            </div>
        </div>
    </div>
</div>
<script>
function verificastatus(idloja){

    var numero = $("#module_whatsappnotifi_numero_"+idloja).val();
    var instance = $("#module_whatsappnotifi_instance_"+idloja).val();
    var token = $("#module_whatsappnotifi_token_"+idloja).val();
    $("#btnvalida"+idloja).html("Validando....")

    if(instance == "" || token == "" || numero == "" ){
        $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12");
        $("#retornovalidacaomsg"+idloja).html("Informe o número, instância e token");
        $("#btnvalida"+idloja).html("Verificar")
            setTimeout(function(){
                $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12 hidden")
            } ,3000);
        return false;
    }

    var url = "https://api.chat-api.com/"+instance+"/status?token="+token;

    $.getJSON(url, function(data, textStatus, jqXHR){
           // alert(data.accountStatus);
            $("#retonovalidacao"+idloja).attr("class","alert alert-success col-sm-12");
            $("#retornovalidacaomsg"+idloja).html(data.accountStatus);
            setTimeout(function(){
                $("#retonovalidacao"+idloja).attr("class","alert alert-success col-sm-12 hidden")
            } ,5000);
            $("#btnvalida"+idloja).html("Verificar")
        })
        .done(function (data, textStatus, jqXHR) { 
            console.log(data.accountStatus); 
        })
        .fail(function (jqxhr,settings,ex) { 

            $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12");
            $("#retornovalidacaomsg"+idloja).html(jqxhr.responseText);
            setTimeout(function(){
                $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12 hidden")
            } ,5000);
            $("#btnvalida"+idloja).html("Verificar")

            // alert('failed, '+ ex); 
            
        });

    // $.ajax({
    //     type: 'GET',
    //     url: url,
    //     success: function(data){
    //         alert(JSON.parse(data[0]))
    //     },
    //     error: function(error){
    //         text =$.parseJSON(error.responseText);
    //         $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12");
    //         $("#retornovalidacaomsg"+idloja).html(text.error);
    //         setTimeout(function(){
    //             $("#retonovalidacao"+idloja).attr("class","alert alert-danger col-sm-12 hidden")
    //         } ,5000);
    //         $("#btnvalida"+idloja).html("Verificar")
    //     }
    // })
}

</script>
{{ footer }}
